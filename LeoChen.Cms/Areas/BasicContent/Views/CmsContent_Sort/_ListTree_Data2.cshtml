@using LeoChen.Cms.Data
@using NewLife.Cube
@using NewLife.Cube.ViewModels
@using XCode
@using XCode.Membership

@{
    var nodeList = Model as List<CmsContent_Sort> ?? new List<CmsContent_Sort>();
    var level = ViewData["Level"] as int? ?? 0;
    var fields = ViewBag.Fields as FieldCollection;
    var fact = ViewBag.Factory as IEntityFactory;
    var ukey = fact.Unique;
}

@foreach (var entity in nodeList)
{
    if (entity == null) continue;

    var hasChildren = entity.Children != null && entity.Children.Count > 0;
    var indent = level * 24;

    <tr class="ccsrow" data-id="@entity.ID" data-pid="@entity.Pid">
        @foreach (var item in fields)
        {
            if (item.Name == "Name")
            {
                <td class="text-left">
                    <div style="padding-left: @(indent)px; display: flex; align-items: center; padding-top:5px">
                        @if (hasChildren)
                        {
                            <!-- 有子节点：用Glyphicons箭头图标（初始展开状态→右箭头） -->
                            <i class="toggle-icon glyphicon glyphicon-chevron-right"
                               style="cursor: pointer; width: 18px; height: 18px; margin-right: 4px; text-align: center; color:#337ab7;"></i>
                        }
                        else
                        {
                            <!-- 无子节点：空白占位（与图标宽度一致，避免布局偏移） -->
                            <span style="width: 18px; height: 18px; display: inline-block; margin-right: 4px;"></span>
                        }
                        @entity.Name
                    </div>
                </td>
            }
            else if (item.Name == "Sorting")
            {
                <td class="text-right" style="width: 100px;">
                    <input type="number"
                           class="form-control input-sm"
                           style=" text-align: right; padding: 2px 5px;"
                           name="sorting"
                           value="@entity.Sorting"
                           data-id="@entity.ID"
                           title="可输入排序值（未启用保存功能）">
                </td>
            }
            else if (item.Name == "Enable")
            {
                <td class="text-center" style="padding-top:10px">
                    <a href="@Url.Action("SetEnable", null, new { id = @entity.ID, enable = !@entity.Enable })" data-action="action">
                        @await Html.PartialAsync("_Icon_Boolean", @entity.Enable)
                    </a>
                </td>
            }
            else
            {
                <td class="text-center">
                    <div style="padding-top:5px">
                        @entity[item.Name]
                    </div>
                </td>
            }
        }
        @if (this.Has(PermissionFlags.Detail, PermissionFlags.Update, PermissionFlags.Delete))
        {
            <td class="text-center"  style="padding-top:10px">
                @await Html.PartialAsync("_List_Data_Action", (Object)entity)
            </td>
        }
        <td type="hidden" class="hidden" style="width: 0px;"><input type="text" name="oldsorting"
                                                                    value="@entity.Sorting"/></td>
        <td type="hidden" class="hidden" style="width: 0px;"><input type="text" name="id" value="@entity.ID"/></td>
    </tr>

    @if (hasChildren)
    {
        ViewData["Level"] = level + 1;
        await Html.RenderPartialAsync("_ListTree_Data2", entity.Children);
    }
}